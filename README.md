# WLTP
[![JupyterLab for WLTP](https://mybinder.org/badge_logo.svg)][1]

UNECE's WLTP reference implementation in Python


[TOC]

## Contents
- Python code implementing the WLTP algorithm (CURRENTLY OLD PHASE1A in `master` branch).
- The original files of the algo (document & MSAccess db).
- Notebooks to process the vehicle data, build HDF5-dbm launch the algo, etc::

      CarsDB-msaccess.ipynb       populate h5db with Heinz test-car input & output 
      CarsDB-phase1a.ipynb        populate h5db with results from the old python code
      CarsDB-compare.ipynb        print comparison results for cars in the h5db
      HDF5-APIh-help.ipynb        list usefull HDF5 methods
      *.Rmd                       R-markdown git-tracked files paired with *.ipynb notebooks 
      nbutils.py                  support code for the above notebooks
      VehData/                    folder with raw input & results (e.g Heinz's msaccess DB)
          +--WltpCars.h5          the h5db where all data are stored
      binder/                     configurations for launching demo in https://mybinder.org
      conda/
          +--environment.yaml     reproduce this conda-env with: `conda create -f conda/environment.yaml`
      README.md                   this file

> **Note:**
> It is the `*.Rmd` files that are stored in the git-repo of this project
> that are synced automatically from `.ipynb` notebooks by the *jupytext*
> jupyter-lab extension.


## HDF5
Heinz Steven has implemented the original reference algorithm in the [`WLTP_GS_calculation_15032019_for_prog_code_subgroup.accdb`](./WLTP_GS_calculation_15032019_for_prog_code_subgroup.accdb) *MSAccess* database.
The MSAccess database facilitated the development & execution of the algorithm 
by storing any and all data needed during those phases.

To substitute those facilities i used the *pandas*+*HDF5* file-format to store data, 
peristently, across code runs.

- Help on `pandas` HDF5 facilities: https://pandas.pydata.org/pandas-docs/stable/user_guide/io.html#io-hdf5
- Help on the underlying `tables` library: https://www.pytables.org/
- Use []`vitables` GUI application](http://vitables.org/Screenshots/)
  to inspect the file (install it with: `conda install vitables`). 
- All major API methods of those libraries are listed  at the top 
  of the `CarsDB.ipynb` notebook.

### HDF5 Tree
```
vehicles/
    +--v001/
    |   +--props          (series) all kv-pairs from input/specs + SM, ASM
    |   +--pwot           (df) a single-column df(wot) indexed by n
    |   +--out1
    |   |   +--cycle      (df) cycle-run generated by HeinzDb
    |   |   +--props      (series) scalar inputs & outputs generated by HeinzDb
    |   |
    |   +--out2           (df) results generated by Python
    |       +--cycle      (df) cycle-run generated by Python 
    |       +--props      (series) scalar outputs generated by Python
    |
    +--v002/
        ...
```

## Recreate this Jupyter-lab server
You may launch and experiment with [a *live* demo of this repository][1].

Otherwise, you may use a *miniconda3* environment to launch it locally.
All installed conda libraries are kept in the `./conda/environment.yaml` file.

> **Note:**
> Maintain the env-file by running this terminal command after any programm (un)install::
>     
>     conda env export -n jupyter | grep -v nodejs > conda/environment.yaml 

To replicate this *conda environment*, follow these instructions:

### 0. Install Conda
Install [*miniconda3*](https://docs.conda.io/en/latest/miniconda.html) 
(or the full *Anaconda* distribution).
   Instructions vary for your Operating System.

### 1. Create a conda environment
Reproduce the *exact same* conda-env with::

```bash
$ conda env create -f conda/environment.yaml
$ conda activate jupyter
```

> **Tip:**
> You may install the latest necessary packages (without pinned versions) 
> with this 2 commands::
> 
> ```bash
> $ conda create -n jupyter
> $ conda activate jupyter
> $ conda install  --override-channels -c ankostis -c conda-forge -c defaults pip  jupyterlab nodejs qgrid jupytext  scipy matplotlib ipympl seaborn black jsonschema==2.6.0 pytables h5py wltp xlrd pandalone sphinx ruamel.yaml xonsh
> $ pip install  blackcellmagic columnize
> $ ./binder/postBuild
> ```


On *Windows* you need additionally *Git* and *NodeJS*. 
You may install them also through *conda* system::

```bat
> conda install m2-git nodejs m2-base
```

(`m2-base` contains optional Unix command-line utilities)



#### 2. Clone the git repo with the Notebooks

Change to the directory you want to work, and run these commands::

```bash
$ git clone http://github.com/JRCSTU/wltp wltp.git --branch=jupyter --depth=1
$ cd wltp.git
```


### 3. Enable *Jupyterlab* extensions

> (working `nodejs`* & `npm` commands are needed there)

Install widgets extension and rebuild the jupyterlab
(if you skip this, jupyter will ask you to *BUILD* on your first launch):

    ## Once for all extensions of a jupyter installation
    jupyter nbextension enable --py --sys-prefix widgetsnbextension    # for jupyter-notebook server
    jupyter labextension install @jupyter-widgets/jupyterlab-manager   # for jupyter-lab server

    jupyter lab build

Alternatively, you may follow the explicit instructions of each extension,
linked site below:

- [`jupytext`](https://github.com/mwouts/jupytext): needed to convert git-cloned files into *notebooks*.
  As a quick reference, do these steps:

  - You need the jupyterlab config-file; run this to generate it, if it does not exist::

        jupyter lab --generate-config
  
  - Append this to the bottom of your jupyter-config file::
  
  
        ## Git only r-Markdown diffs
        # From https://towardsdatascience.com/version-control-with-jupyter-notebooks-f096f4d7035a
        c.NotebookApp.contents_manager_class="jupytext.TextFileContentsManager"
        c.ContentsManager.default_jupytext_formats = ".ipynb,.Rmd"

- [`qgrid`](https://github.com/quantopian/qgrid#installation)::

      jupyter nbextension enable --py --sys-prefix qgrid                 # for jupyter-notebook server
      jupyter labextension install qgrid                                 # for jupyter-lab server
      
- [`jupyter-matplotlib`](https://github.com/matplotlib/jupyter-matplotlib)::

      jupyter labextension install jupyter-matplotlib

> **Tip:**
> Make sure you restart the server after installing lab extensions - restarting 
> just the the kernel is not enough.


### 5. Convert git-cloned scripts into *notebooks* `jupytext`

Run this command in the directory of the gir-repo you cloned::

      jupytext --to ipynb *.Rmd

> **Tip**: 
> After jupyterlab hash launched, you may *right-click* a `.Rmd` file and 
> click **Open with | Notebook**, and **Save** to generate a freshly created notebook 
> (just remember to close the `.Rmd` file).


### 5. Launch *Jupyterlab* server
Change directory to the folder you wish to store the notebooks,
and launch jupyterlab with::

    jupyter lab

A new tab should open automatically in your browser.



## Code to extract data from MSAccess

In case it's needed in the future
...but cannot run in this server bc `pyodbc` lib cannot runs on *Linux* :-( 

```python
## Can run only on WINDOWS only!!
#
import pyodbc

def mdb_connect(db_file, user='admin', password = '', old_driver=False):
    """
    :param db_file:
        must be an absolute path
    """
    driver_ver = '*.mdb'
    if not old_driver:
        driver_ver += ', *.accdb'

    odbc_conn_str = ('DRIVER={Microsoft Access Driver (%s)}'
                     ';DBQ=%s;UID=%s;PWD=%s' %
                     (driver_ver, db_file, user, password))

    return pyodbc.connect(odbc_conn_str)

fname='WLTP_GS_calculation_15032019_for_prog_code_subgroup.accdb'
conn = mdb_connect(fname)
crsr = conn.cursor()

print([i.table_name for i in crsr.tables(tableType='TABLE')]
print([i.column_name for i in crsr.columns('gearshift_table_all')]
```

## Questions to Heinz

- How to extrapolate `PWot`?  eg. when `min(pwot[n]` > `n_idle`?


[1]: https://mybinder.org/v2/gh/JRCSTU/wltp/jupyter?urlpath=lab
