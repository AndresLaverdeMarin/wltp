# WLTP
UNECE's WLTP reference implementation in Python

[TOC]

## Contents
- Python code implementing the WLTP algorithm.
- The original files of the algo (document & MSAccess db).
- Notebooks to process the vehicle data, build HDF5-dbm launch the algo, etc::

      CarsDB-msaccess.ipynb   populate h5db with Heinz test-car input & output 
      CarsDB-phase1a.ipynb    populate h5db with results from the old python code
      CarsDB-compare.ipynb    print comparison results for cars in the h5db
      HDF5-APIh-help.ipynb    list usefull HDF5 methods
      nbutils.py              support code for the above notebooks
      WltpCars.h5             the h5db where all data are stored
      
> **Note:**
> It is the `.Rmd` files that are stored in the git-repo of this project;
> these aresynced  automatically with `.ipynb` notebooks byt the *jupytext*
> jupyter-lab extension.


## HDF5
Heinz Steven has implemented the original reference algorithm in the [`WLTP_GS_calculation_15032019_for_prog_code_subgroup.accdb`](./WLTP_GS_calculation_15032019_for_prog_code_subgroup.accdb) *MSAccess* database.
The MSAccess database facilitated the development & execution of the algorithm 
by storing any and all data needed during those phases.

To substitute those facilities i used the *pandas*+*HDF5* file-format to store data, 
peristently, across code runs.

- Help on `pandas` HDF5 facilities: https://pandas.pydata.org/pandas-docs/stable/user_guide/io.html#io-hdf5
- Help on the underlying `tables` library: https://www.pytables.org/
- Use []`vitables` GUI application](http://vitables.org/Screenshots/)
  to inspect the file (install it with: `conda install vitables`). 
- All major API methods of those libraries are listed  at the top 
  of the `CarsDB.ipynb` notebook.

### HDF5 Tree
```
vehicles/
    +--v001/
    |   +--props          (series) all kv-pairs from input/specs + SM, ASM
    |   +--pwot           (df) a single-column df(wot) indexed by n
    |   +--out1
    |   |   +--cycle      (df) cycle-run generated by HeinzDb
    |   |   +--props      (series) scalar inputs & outputs generated by HeinzDb
    |   |
    |   +--out2           (df) results generated by Python
    |       +--cycle      (df) cycle-run generated by Python 
    |       +--props      (series) scalar outputs generated by Python
    |
    +--v002/
        ...
```

## Recreate this Jupyter-lab server
This server runs on a full *Anaconda* environment.  
All installed dependencies are kept in the `./environment.yaml` file.

> **Note:**
> Maintain the env-file by running this terminal command after any programm (un)install::
>     
>     conda env export -n jupyter > environment.yaml 

To reproduce this server:

0. Install *miniconda3* or the full *Anaconda* distribution (as this server has done).
   Instructions vary for your Operating System.
   
1. Recreate the conda-env::

   ```bash
   $ conda env create -f environment.yaml
   ```

   > **Tip:**
   > The really necessary packages are these::
   > 
   >     conda install \
   >         black blackcellmagic columnize ipympl jsonschema==2.6.0 jupytext \
   >         matplotlib nodejs pandalone xonsh qgrid ruamel.yaml tables wltp xlrd

2. then follow the instructions in each linked site below to install 
   these jupyer-lab extensions (working `nodejs`* & `npm` commands are needed):

   - [`qgrid`](https://github.com/quantopian/qgrid#installation)
   - [`jupyter-matplotlib`](https://github.com/matplotlib/jupyter-matplotlib)
   - [`jupytext`](https://github.com/mwouts/jupytext): optional, if you want 
     to commit changes into this project's git-repo.

3. finally launch it with:
  
   ```bash
   $ jupyter lab
   ```

   > **Tip:**
   > You don't need to restart the server after installing lab extensions - restarting 
   > just the the kernel is enough.


## Code to extract data from MSAccess

In case it's needed in the future
...but cannot run in this server bc `pyodbc` lib cannot runs on *Linux* :-( 

```python
## Can run only on WINDOWS only!!
#
import pyodbc

def mdb_connect(db_file, user='admin', password = '', old_driver=False):
    """
    :param db_file:
        must be an absolute path
    """
    driver_ver = '*.mdb'
    if not old_driver:
        driver_ver += ', *.accdb'

    odbc_conn_str = ('DRIVER={Microsoft Access Driver (%s)}'
                     ';DBQ=%s;UID=%s;PWD=%s' %
                     (driver_ver, db_file, user, password))

    return pyodbc.connect(odbc_conn_str)

fname='WLTP_GS_calculation_15032019_for_prog_code_subgroup.accdb'
conn = mdb_connect(fname)
crsr = conn.cursor()

print([i.table_name for i in crsr.tables(tableType='TABLE')]
print([i.column_name for i in crsr.columns('gearshift_table_all')]
```

## Questions to Heinz
- Running a car in the MSAccess needs just selecting its `vehicle_num`?
  (no other setting touched?)
- How to extrapolate `PWot`?  eg. when `min(pwot[n]` > `n_idle`?
