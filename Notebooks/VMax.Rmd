---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Compare results in the DB

```{python}
## To autoreload codein python files here.
# %load_ext autoreload
# %autoreload 2

## Add %%black at the top of a cell, and re-evaluate it, 
# to format it before git-commits, and ease diffs.
# %load_ext blackcellmagic
```

```{python}
from typing import Union, List, Callable, Any, Sequence as Seq
import io
import logging
from pathlib import Path, PurePosixPath as P
import sys

from columnize import columnize
import numpy as np
import pandas as pd
from pandas import HDFStore, IndexSlice as idx
from pandas.core.generic import NDFrame
from matplotlib import pyplot as plt
import qgrid
import wltp
from wltp.experiment import Experiment

## Add tests/ into `sys.path` to import `vehdb` module.
#
proj_dir = str(Path(wltp.__file__).parents[1] / "tests")
if proj_dir not in sys.path:
    sys.path.insert(0, proj_dir)

import vehdb

idx = pd.IndexSlice
log = logging.getLogger("VMax.ipynb")
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s|%(levelname)4.4s|%(module)s:[%(funcName)s]:\n  +--> %(message)s",
    datefmt="%Y-%m-%d,%H:%M:%S",
)

pd.set_option("display.max_columns", 32)
```

```{python}
# %matplotlib inline
```

```{python}
## DEFINITIONS
#
inp_h5fname = 'VehData/WltpGS-msaccess.h5'
out_h5fname = 'VehData/WltpGS-pyalgo.h5'
c_n, c_p, c_n_norm, c_p_norm = 'n', 'Pwot', 'n_norm', 'p_norm'

#vehdb.print_nodes(inp_h5fname)
#vehdb.print_nodes(out_h5fname)
```

## Good case

```{python}
def read_veh(vehnum, silent=False):
    ac_props, wot, _ = vehdb.load_vehicle_accdb_inputs(inp_h5fname, vehnum)
    py_props, _, gwots = vehdb.load_vehicle_pyalgo(out_h5fname, vehnum)

    if not silent:
        display(ac_props[["no_of_gears", "gear_v_max", "v_max"]], "", py_props)
        ax = None
        ax = gwots.loc[:, ("g6 g5 g4".split(), "p_avail")].plot(ax=ax)
        gwots.loc[:, ("g6 g5 g4".split(), "p_road_loads")].plot(ax=ax)

    return ac_props, py_props, wot, gwots


ac_props, py_props, wot, gwots = read_veh(21)
```

```{python}
display(wot)
```

```{python}
def plot_gwots(ac_props, py_props, gwots, g, bottom_g, *, offset=2):
    gwots.index.name = "V [kmh]"
    v_max_ac = ac_props["v_max"]
    v_max = py_props["v_max"]
    g_top = ac_props["no_of_gears"]
    g_max = py_props["g_v_max"]
    g_max_acc = ac_props["gear_v_max"]
    v_range = idx[v_max - offset : v_max + offset]
    ax = gwots.loc[v_range, (f"g{g}", "p_road_loads")].plot(
        linewidth=3
    )
    ax = gwots.loc[v_range, (slice(f"g{g_top}", f"g{bottom_g}"), "p_avail")].plot(ax=ax)
    ax.axvline(v_max, color="orange", label=f"v_max_python(g{g_max})")
    ax.axvline(v_max_ac, color="green", label=f"v_max_accdb(g{g_max_acc})")
    ax.legend()
    ax.grid(axis="x", which="both")


plot_gwots(ac_props, py_props, gwots, 6, 5)
```

```{python}
def disp_gwots(ac_props, py_props, gwots, g, offset=0.5):
    gwots.index.name = "V [kmh]"
    v_max_ac = ac_props["v_max"]
    v_max = py_props["v_max"]
    # display(gwots['g5'].dropna())
    display(gwots.loc[v_max - offset : v_max + offset, f"g{g}"])

disp_gwots(ac_props, py_props, gwots, 6)
```

```{python}
disp_gwots(ac_props, py_props, gwots, 5)
```

## BAD case
```
         v_max  g_vmax
accdb:   141.1       6
pyalgo:  141.1       5
```
Strangely, accdb finds the correct `v_max`, but `g6` does not seem to cross `P_res` at that point...

```{python}
ac_props, py_props, wot, gwots = read_veh(25)
```

```{python}
plot_gwots(ac_props, py_props, gwots, 6, 5)
```

```{python}
disp_gwots(ac_props, py_props, gwots, 6)
disp_gwots(ac_props, py_props, gwots, 5)
```
