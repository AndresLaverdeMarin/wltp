---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.1.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
## To autoreload codein python files here.
# %load_ext autoreload
# %autoreload 2

## Add %%black at the top of a cell, and re-evaluate it, 
# to format it before git-commits, and ease diffs.
# %load_ext blackcellmagic
```

```{python}
from typing import Union
import io
from pathlib import PurePosixPath as P

import pandas as pd
from wltp.experiment import Experiment
from ruamel.yaml import YAML

import nbutils as nbu
```

```{python}
## DEFINITIONS
#
h5fname = 'WltpCars.h5'
c_n, c_p, c_n_norm, c_p_norm = 'n', 'Pwot', 'n_norm', 'p_norm'
```

```{python}
props, pwot = nbu.load_vehicle(h5fname, vehnum, "props", "pwot")
props.index, pwot.index
```

```{python}
def run_old_wltp_on_db_vehice(vehnum):
    props, pwot = nbu.load_vehicle(h5fname, vehnum, "props", "pwot")
    
    ndvs = [props["ndv_%i" % g] for g in range(1, props["no_of_gears"] + 1)]
    norm_pwot = normalize_pwot(pwot, props.idling_speed, props.rated_speed, props.rated_power)
    v_max = int(props.v_max_declared)
    inverse_SM = 1.0 - props.SM 
    
    input_model = nbu.yaml_loads(
        f"""
        vehicle:
          gear_ratios:  {ndvs}
          resistance_coeffs:
            - {props.f0} 
            - {props.f1}
            - {props.f2}
          p_rated:      {props.rated_power}
          unladen_mass: {props.kerb_mass}
          test_mass:    {props.test_mass}
          n_rated:      {props.rated_speed}
          n_idle:       {props.idling_speed}
          v_max:        {v_max}
        params:
          f_safety_margin: {inverse_SM}
        """
    )
    input_model['vehicle']['full_load_curve'] = norm_pwot
    
    exp = Experiment(input_model)
    output_model = exp.run()

    return output_model
# output_model = run_old_wltp_on_db_vehice(14)
# display(output_model["cycle_run"])
```

```{python}
nbu.print_nodes(h5fname)
```

```{python}
vehnum = 14
with nbu.openh5(h5fname) as h5db:
    h5db[vehnode(vehnum, 'out2', 'cycle')] =  output_model['cycle_run']
    h5db[vehnode(vehnum, 'out2', 'props')] =  pd.Series(output_model['vehicle'])
```
