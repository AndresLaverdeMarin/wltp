---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.1.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Parse excel files into a HDF5 file

## instructions, in case you need to run it in your own jupyter
run only once on the server:
```bash
conda install wltp pandalone qgrid
```
...and ensure `qgrid` is properly installed for *jupyter lab*,
by following [the instructions](https://github.com/quantopian/qgrid#installation).

```{python}
from pandalone import xleash
import qgrid
```

```{python}
# to get help on xleash:
xleash?
```

## Code to extract data from MSAccess
in case it is needed in the future
...but cannot run in here, bc this server is Linux :-( 

```python
## Can run only on WINDOWS only!!
#
import pyodbc

def mdb_connect(db_file, user='admin', password = '', old_driver=False):
    """
    :param db_file:
        must be an absolute path
    """
    driver_ver = '*.mdb'
    if not old_driver:
        driver_ver += ', *.accdb'

    odbc_conn_str = ('DRIVER={Microsoft Access Driver (%s)}'
                     ';DBQ=%s;UID=%s;PWD=%s' %
                     (driver_ver, db_file, user, password))

    return pyodbc.connect(odbc_conn_str)

fname='WLTP_GS_calculation_15032019_for_prog_code_subgroup.accdb'
conn = mdb_connect(fname)
crsr = conn.cursor()

print([i.table_name for i in crsr.tables(tableType='TABLE')]
print([i.column_name for i in crsr.columns('gearshift_table_all')]
```

```{python}
from pandas import HDFStore

h5fname = 'WltpCars.h5'
# Test cars delivered by Heinz on 13 May 2019
xlfname = "example vehicles for the prog code validation.xlsx"
c_vehnum = 'vehicle_no'
```

```{python}
with HDFStore(h5fname) as h5db:
    print('\n'.join(h5db.keys()[:7]))
```

```{python}
specs = xleash.lasso('%s#technical data!::["df"]' % xlfname)
pwots = xleash.lasso('%s#wot power curves!::["df"]' % xlfname)
```

```{python}
display(qgrid.show_grid(specs))
display(qgrid.show_grid(pwots))
```

```{python}
with HDFStore(h5fname) as h5db:
    h5db.put('/cars/input/specs', specs)
    h5db.put('/cars/input/pwots', pwots)
```

```{python}
def extract_SM_from_pwot(pwot, 
                         c_n='n', c_pwot = 'Pwot',
                         c_SM='SM', c_ASM='ASM') -> "Tuple(pd.DataFrame, float)":
    """
    Keep just (n, Pwot, ASM) columns & extract SM column as scalar value.
    
    :param pwot:
        the wot-curve for a single vehicle, a df like::
        
            IX	vehicle_no	n	Pwot	SM	ASM
            -----------------------
            0	1			800	5.43	0.1	0.0
            0	1			900	9.01	0.1	0.0
    :return:
        wot(n: pwot, ASM), ASM
        where `wot` is indexed by engine-speed(n)
    """
    pwot2 = pwot.loc[:, [c_n, c_pwot, c_ASM]].set_index(c_n)
    row1 = pwot.iloc[0, :]
    
    SM = row1[c_SM]
    assert (pwot[c_SM] == SM).all(), pwot

    return pwot2, SM

# ## TEST
# extract_SM_from_pwot(pwots.loc[pwots[c_vehnum] == 3])
```

```{python}
def store_group_per_car(h5db, specs,
                        c_vehnum='vehicle_no',
                        c_SM='SM', c_ASM='ASM'):
    """
    Distribute vehicle-specs each on a single HDF5 node with 2 children::
    
        cars/input/veh001
            +--spec = all kv-pairs from matrix + SM, ASM
            +--pwot = a single-column df(wot) indexed by n
    """
    for _, spec in specs.iterrows():
        vehnum = spec[c_vehnum]
        vgroup = 'cars/input/veh%0.3d' % vehnum 
        
        pwot = pwots.loc[pwots[c_vehnum] == vehnum, :]
        pwot, SM = extract_SM_from_pwot(pwot)

        spec[c_SM] = SM

        h5db.put('%s/spec' % vgroup, spec)
        h5db.put('%s/pwot' % vgroup, pwot)


with HDFStore(h5fname) as h5db:
    store_group_per_car(h5db, specs)
```

```{python}
## COMPRESS x100 HDF5: 122MB --> ~2MB.
#
# !ls -lh WltpCars*
# !ptrepack WltpCars.h5 --complevel=5 --complib=blosc:lz4hc -o WltpCars.1.h5
# !mv WltpCars.1.h5 WltpCars.h5
# !ls -lh WltpCars*
```

```{python}
with HDFStore(h5fname) as h5db:
    print('\n'.join(h5db.keys()))
```
